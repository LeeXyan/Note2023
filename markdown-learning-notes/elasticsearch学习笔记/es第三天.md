



# ğŸ’®ç›®å½•

[TOC]

## æœ€å·¦å‰ç¼€æŸ¥è¯¢ï¼ˆmatch_phrase_prefixï¼‰

å½“æˆ‘ä»¬åœ¨æµè§ˆå™¨æŸ¥è¯¢`beautiful`è¿™ä¸ªå•è¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‡ºç°ä¸ä¼šæ‹¼çš„æƒ…å†µï¼Œæˆ‘ä»¬å°±å¸Œæœ›ä½†æˆ‘ä»¬è¾“å…¥å‰å‡ ä¸ªå­—æ¯çš„æ—¶å€™æ”¶ç´¢å¼•æ“å°±ä¼šè‡ªåŠ¨ç»™æˆ‘ä»¬æ˜¾ç¤ºå‡º`beautiful`è¿™ä¸ªå•è¯ï¼Œ

![image-20210204094211889](https://gitee.com/yxinmiracle/pic/raw/master/20210204094211.png)

æ¯”å¦‚ç™¾åº¦å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œé‚£ä¹ˆï¼Œåœ¨esä¸­åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

æ•°æ®å‡†å¤‡ï¼š

```tiki wiki
PUT d1/doc/1
{
  "title":"beautiful girl"
}

PUT d1/doc/2
{
  "title":"baeu"
}

PUT d1/doc/3
{
  "title":"beautiful"
}
```

æŸ¥è¯¢ï¼š

```tiki wiki
GET d1/doc/_search
{
  "query": {
    "match_phrase_prefix": {
      "title": "beau"
    }
  }
}
```

ç»“æœï¼š

![image-20210204094530523](https://gitee.com/yxinmiracle/pic/raw/master/20210204094530.png)



## multi_matchæŸ¥è¯¢

æ•°æ®å‡†å¤‡ï¼š

```tiki wiki
# æŸ¥è¯¢titleå’Œcontentä¸­éƒ½æœ‰å…³é”®å­—pythonçš„
PUT d2/doc/1
{
  "title":"pythonæ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€",
  "content":"æ˜¯çš„,ä½ è¯´çš„æ²¡é”™ï¼Œpythonå°±æ˜¯è¿™æ ·çš„"
}
```

éœ€æ±‚ï¼šæŸ¥è¯¢titleå’Œcontentä¸­éƒ½æœ‰å…³é”®å­—pythonçš„çš„æ•°æ®

æŸ¥è¯¢ï¼š

```tiki wiki
GET d2/doc/_search
{
  "query": {
    "multi_match": {
      "query": "python",
      "fields": ["title","content"]
    }
  }
}
```

ç»“æœï¼š

![image-20210204094718603](https://gitee.com/yxinmiracle/pic/raw/master/20210204094718.png)

## termä¸matchçš„åŒºåˆ«

### å‰è¨€

termæŸ¥è¯¢æŸ¥æ‰¾åŒ…å«æ–‡æ¡£ç²¾ç¡®çš„å€’æ’ç´¢å¼•çš„è¯æ¡ã€‚ä¹Ÿå°±æ˜¯ç²¾ç¡®æŸ¥æ‰¾

### åŒºåˆ«

1. `match`æ˜¯ç»è¿‡`analyer`çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡æ¡£é¦–å…ˆè¢«åˆ†æå™¨ç»™å¤„ç†äº†ã€‚æ ¹æ®ä¸åŒçš„åˆ†æå™¨ï¼Œåˆ†æçš„ç»“æœä¹Ÿç¨æ˜¾ä¸åŒï¼Œç„¶åå†æ ¹æ®åˆ†è¯ç»“æœè¿›è¡ŒåŒ¹é…
2. `term`åˆ™ä¸ç»è¿‡åˆ†è¯ï¼Œä»–æ˜¯ç›´æ¥å»å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾äº†ç²¾ç¡®çš„å€¼äº†

æ•°æ®å‡†å¤‡

```tiki wiki
PUT w10
{
  "mappings": {
    "doc":{
      "properties":{
        "t1":{
          "type":"text"
        },
        "t2":{
          "type":"keyword"
        }
      }
    }
  }
}

PUT w10/doc/1
{
  "t1":"hi single dog",
  "t2":"hi single dog"
}

```

æˆ‘ä»¬å°†t2çš„ç´¢å¼•ç±»å‹ç½®ä¸ºkeywordï¼Œè¿™æ ·è¿™ä¸ªç´¢å¼•åœ¨å­˜å‚¨çš„è¿‡ç¨‹ä¸­å°±ä¸ä¼šè¢«åˆ†è¯ã€‚

ä½¿ç”¨matchæ¥æŸ¥è¯¢t1ï¼š

```tiki wiki
GET w10/doc/_search
{
  "query": {
    "match": {
      "t1": "hi"
    }
  }
}
```

![image-20210204100751308](https://gitee.com/yxinmiracle/pic/raw/master/20210204100751.png)

å¯è§æ˜¯æœ‰æ•°æ®çš„

ä½¿ç”¨matchæ¥æŸ¥è¯¢t2ï¼š

```
GET w10/doc/_search
{
  "query": {
    "match": {
      "t2": "hi"
    }
  }
}
```

![image-20210204100818485](https://gitee.com/yxinmiracle/pic/raw/master/20210204100818.png)

æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ä¸ºç©º

ç”¨termæ¥æŸ¥è¯¢t2ï¼ŒåªæŸ¥è¯¢hiï¼š

```
GET w10/doc/_search
{
  "query": {
    "term": {
      "t2": {
        "value": "hi"
      }
    }
  }
}
```

å¯ä»¥å‘ç°ç»“æœæ˜¯æŸ¥è¯¢ä¸å‡ºä¸œè¥¿çš„ï¼š

![image-20210204103423676](https://gitee.com/yxinmiracle/pic/raw/master/20210204103423.png)

ç”¨termæ¥æŸ¥è¯¢t2ï¼ŒæŸ¥è¯¢hi single dogï¼š

```
GET w10/doc/_search
{
  "query": {
    "term": {
      "t2": {
        "value": "hi single dog"
      }
    }
  }
}

```

![image-20210204103452361](https://gitee.com/yxinmiracle/pic/raw/master/20210204103452.png)

å¯ä»¥çœ‹è§åªæœ‰è¾“å…¥å®Œæ•´çš„è¯è¯­esæ‰èƒ½å¤ŸæŸ¥è¯¢å‡ºæ¥

## è¯ç»„ï¼Œè¯æ¡å»ºè®®å™¨ï¼ˆphraseï¼Œtermï¼‰

### è¯æ¡å»ºè®®å™¨

è¯æ¡å»ºè®®å™¨å°±æ˜¯å½“ç”¨æˆ·è¾“å…¥ä¸€å¥è¯æˆ–è€…ä¸€ä¸ªè¯çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰é”™è¯¯ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„`elasticsearch`æ‰“æˆ äº†`elasticsercha`ç±»ä¼¼çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè¿›è¡Œè¯æ¡çš„å»ºè®®æ¥ç»™ç”¨æˆ·çº é”™ï¼Œæ•°æ®å‡†å¤‡ï¼š

```tiki wiki
PUT s4
{
  "mappings": {
    "doc":{
      "properties":{
        "title":{
          "type":"text",
          "analyzer":"standard"
        }
      }
    }
  }
}

PUT s4/doc/1
{
  "title":"Lucene is cool"
}

PUT s4/doc/2
{
  "title":"Elasticsearch builds on top of lucene"
}

PUT s4/doc/3
{
  "title":"Elasticsearch rocks"
}

PUT s4/doc/4
{
  "title":"elasticsearch is rock solid"
}
```

ä»£ç ï¼š

```tiki wiki
# è¯æ¡
GET s4/doc/_search
{
  "suggest": {
    "my_s": {
      "text": "lucen and elasticsercha rook",
      "term": {
        "field": "title"
      }
    }
  }
}
```

ç»“æœï¼š

![image-20210205110221322](https://gitee.com/yxinmiracle/pic/raw/master/20210205110221.png)

å¯ä»¥çœ‹å‡ºè¯æ¡å»ºè®®è¯æ˜¯å°†æˆ‘ä»¬æ¯ä¸€ä¸ªè¯è¯­è¿›è¡Œåˆ†è¯ä¹‹åå†æ¥çº é”™ã€‚

### è¯ç»„å»ºè®®å™¨

è¯ç»„å»ºè®®å™¨æ˜¯å°†æˆ‘ä»¬ä¸€å¥è¯çœ‹æˆä¸€ä¸ªæ•´ä½“æ¥è¿›è¡Œçº é”™

æ•°æ®ä¾æ—§æ˜¯è·Ÿä¸Šé¢çš„æ•°æ®æ˜¯ä¸€æ ·çš„

ä»£ç ï¼š

```tiki wiki
# è¯ç»„
GET s4/doc/_search
{
  "suggest": {
    "my_s": {
      "text": "lucen and elasticsercha rook",
      "phrase": {
        "field": "title"
      }
    }
  }
}
```

ç»“æœï¼š

![image-20210205110803487](https://gitee.com/yxinmiracle/pic/raw/master/20210205110803.png)

#### è¯ç»„å»ºè®®å™¨åŠ é«˜äº®

æˆ‘ä»¬çš„çº é”™ç»“æœè¿˜å¯ä»¥è¿›è¡Œé«˜äº®çš„å±•ç¤ºï¼š

```tiki wiki
# çº é”™è¯ç»„ åŠ é«˜äº®
GET s4/doc/_search
{
  "suggest": {
    "my_s": {
      "text": "lucen and elasticsercha rook",
      "phrase": {
        "field": "title",
        "highlight":{
          "pre_tag":"<b style='color:red;'>",
          "post_tag":"</b>"
        }
      }
    }
  }
}
```

ç»“æœï¼š

![image-20210205111100110](https://gitee.com/yxinmiracle/pic/raw/master/20210205111100.png)

## å®Œæˆå»ºè®®å™¨

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è‡ªåŠ¨å®Œæˆçš„å»ºè®®å™¨â€”â€”æ˜¯ä¸€ä¸ªå¯¼èˆªåŠŸèƒ½ï¼Œæä¾›è‡ªåŠ¨å®Œæˆã€æœç´¢åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç”¨æˆ·è¾“å…¥æ—¶å¼•å¯¼ç”¨æˆ·æŸ¥çœ‹ç›¸å…³ç»“æœï¼Œä»è€Œæé«˜æœç´¢ç²¾åº¦ã€‚ä½†å¹¶ä¸é€‚ç”¨äºæ‹¼æ¥æ£€æŸ¥æˆ–è€…åƒ`term`å’Œ`phrase`å»ºè®®é‚£æ ·çš„åŠŸèƒ½ã€‚
å¦‚æœè¯´åœ¨2000å¹´å·¦å³ï¼Œè‡ªåŠ¨å®Œæˆè¿˜æ˜¯å¾ˆç‚«é…·çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆç°åœ¨å®ƒæ˜¯å¿…å¤‡çš„äº†â€”â€”ä»»ä½•æ²¡æœ‰è‡ªåŠ¨å®ŒæˆåŠŸèƒ½çš„æœç´¢å¼•æ“éƒ½æ˜¯å¾ˆå¤è€çš„ã€‚ç”¨æˆ·æœŸæœ›ä¸€ä¸ªè‰¯å¥½çš„è‡ªåŠ¨å®Œæˆæ¥å¸®åŠ©ç”¨æˆ·å®ç°æ›´å¿«çš„ï¼ˆç‰¹åˆ«æ˜¯ç§»åŠ¨ç«¯ï¼‰ä»¥åŠæ›´å¥½çš„ï¼ˆæ¯”å¦‚è¾“å…¥`e`ï¼Œæœç´¢å¼•æ“å°±åº”è¯¥çŸ¥é“ç”¨æˆ·æƒ³è¦æŸ¥æ‰¾çš„æ˜¯`elasticsearch`ï¼‰æœç´¢ã€‚
ä¸€ä¸ªä¼˜ç§€çš„è‡ªåŠ¨å®Œæˆå°†é™ä½æœç´¢å¼•æ“çš„è´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”¨æˆ·æœ‰ä¸€äº›å¿«é€Ÿæœç´¢å¯ç”¨æ—¶ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è·³è½¬åˆ°ä¸»æµçš„æœç´¢ç»“æœè€Œæ— é¡»æ‰§è¡Œå®Œæ•´çš„æœç´¢ã€‚
é™¤æ­¤ä¹‹å¤–ï¼Œä¸€ä¸ªä¼˜ç§€çš„è‡ªåŠ¨å®Œæˆå¿…é¡»æ˜¯å’Œå¿«é€Ÿçš„ã€ç›¸å…³çš„ï¼š

- å¿«é€Ÿæ˜¯å› ä¸ºå®ƒå¿…é¡»åœ¨ç”¨æˆ·ä¸æ–­è¾“å…¥çš„æ—¶å€™äº§ç”Ÿå»ºè®®ã€‚
- ç›¸å…³åˆ™æ˜¯ç”¨æˆ·å¹¶ä¸å¸Œæœ›å»ºè®®ä¸€ä¸ªæ²¡æœ‰æœç´¢ç»“æœæˆ–è€…æ²¡æœ‰ç”¨å¤„çš„ç»“æœã€‚

é‚£æˆ‘ä»¬ä¾é ä¹‹å‰å­¦è¿‡çš„`match_phrase_prefix`æœ€å·¦å‰ç¼€æŸ¥è¯¢æ¥å®Œæˆè¯¥åŠŸèƒ½ï¼Œä½†æ˜¯è¿™æ ·çš„æŸ¥è¯¢å¯èƒ½ä¸å¤Ÿå¿«ï¼Œå› ä¸ºç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæœç´¢å¼•æ“éœ€è¦åœ¨ç”¨æˆ·è¾“å…¥ä¸‹ä¸€ä¸ªå­—ç¬¦å‰è¿”å›å»ºè®®ç»“æœã€‚
å®Œæˆå»ºè®®å™¨å’Œåé¢çš„ä¸Šä¸‹æ–‡å»ºè®®å™¨å¯ä»¥å¸®åŠ©ç”¨æˆ·æ„å»ºæ›´å¿«çš„è‡ªåŠ¨å®Œæˆï¼Œå®ƒä»¬æ˜¯åŸºäºLuceneçš„suggestå»ºè®®æ¨¡å—è€Œæ„å»ºçš„ï¼Œå°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­çš„æœ‰é™çŠ¶æ€è½¬ç§»æœºä¸­ï¼ˆFSTï¼‰ã€‚FSTå®é™…ä¸Šæ˜¯ä¸€ç§å›¾ã€‚å®ƒå¯ä»¥å°†è¯æ¡ä»¥å‹ç¼©å’Œæ˜“äºæ£€ç´¢çš„æ–¹å¼æ¥å­˜å‚¨ã€‚

![image-20210205113247222](https://gitee.com/yxinmiracle/pic/raw/master/20210205113247.png)

ä¸Šå›¾å±•ç¤ºäº†è¯æ¡`indexã€searchã€suggest`æ˜¯å¦‚ä½•å­˜å‚¨çš„ã€‚å½“ç„¶å®é™…ä¸­çš„å®ç°æ›´åŠ å¤æ‚ï¼Œæ¯”å¦‚å®ƒå…è®¸æˆ‘ä»¬æ·»åŠ æƒé‡ã€‚
FSTï¼ˆ[Finite StateTransducers](https://en.wikipedia.org/wiki/Finite-state_transducer)ï¼‰ï¼Œé€šå¸¸ä¸­æ–‡è¯‘ä½œæœ‰é™çŠ¶æ€ä¼ æ„Ÿå™¨ï¼ŒFSTç›®å‰åœ¨è¯­éŸ³è¯†åˆ«å’Œè‡ªç„¶è¯­è¨€æœç´¢ã€å¤„ç†ç­‰æ–¹å‘è¢«å¹¿æ³›åº”ç”¨ã€‚
FSTçš„åŠŸèƒ½æ›´ç±»ä¼¼äºå­—å…¸ï¼ŒLucene4.0åœ¨æŸ¥æ‰¾Termæ—¶ä½¿ç”¨äº†FSTç®—æ³•ï¼Œç”¨æ¥å¿«é€Ÿå®šä½Termçš„ä½ç½®ã€‚FSTçš„æ•°æ®ç»“æ„å¯ä»¥ç†è§£æˆï¼ˆ`key:value`ï¼‰çš„å½¢å¼ã€‚
åœ¨åŒä¹‰è¯è¿‡æ»¤å™¨ï¼ˆ[SynonymFilter](http://lucene.apache.org/core/3_6_0/api/all/org/apache/lucene/analysis/synonym/SynonymFilter.html)ï¼‰çš„å®ç°ä¸­ç”šè‡³å¯ä»¥ç”¨[HashMap](https://baike.baidu.com/item/hashmap)ä»£æ›¿ï¼Œä¸è¿‡ç›¸æ¯”è¾ƒäºHashMapï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯ï¼š

- ä»¥O(1)çš„æ—¶é—´å¤æ‚åº¦æ‰¾åˆ°keyå¯¹åº”çš„valueã€‚
- ä»¥å­—èŠ‚çš„æ–¹å¼æ¥å­˜å‚¨æ‰€æœ‰çš„Termï¼Œé‡å¤åˆ©ç”¨Term Indexçš„å‰ç¼€å’Œåç¼€ï¼Œä½¿Term - Indexå°åˆ°å¯ä»¥æ”¾è¿›å†…å­˜ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´ï¼Œä¸è¿‡ç›¸å¯¹çš„ä¹Ÿä¼šå ç”¨æ›´å¤šçš„cpuèµ„æºã€‚
- FSTè¿˜å¯ä»¥ç”¨æ¥å¿«é€Ÿç¡®å®štermæ˜¯å¦åœ¨ç³»ç»Ÿä¸­ã€‚

### å®Œæˆå»ºè®®å™¨ï¼šcompletion suggester

ä¸ºäº†å‘Šè¯‰elasticsearchæˆ‘ä»¬å‡†å¤‡å°†å»ºè®®å­˜å‚¨åœ¨è‡ªåŠ¨å®Œæˆçš„FSTä¸­ï¼Œéœ€è¦åœ¨æ˜ å°„ä¸­å®šä¹‰ä¸€ä¸ªå­—æ®µå¹¶å°†å…¶`type`ç±»å‹è®¾ç½®ä¸º`completion`ï¼š

```
# å®Œæˆå»ºè®®å™¨
PUT s5
{
  "mappings": {
    "doc":{
      "properties":{
        "title":{
          "type":"completion",
          "analyzer":"standard"
        }
      }
    }
  }
}
```

æ•°æ®å‡†å¤‡ï¼š

```
PUT s5/doc/1
{
  "title":"Lucene is cool"
}

PUT s5/doc/2
{
  "title":"Elasticsearch builds on top of lucene"
}

PUT s5/doc/3
{
  "title":"Elasticsearch rocks"
}

PUT s5/doc/4
{
  "title":"elasticsearch is rock solid"
}

# my_så»ºè®®ï¼Œmy_termçº é”™
GET s5/doc/_search
{
  "suggest": {
    "text": "lucen",
    "my_s": {
      "completion":{
        "field":"title"
      }
    },
    "my_term":{
      "term":{
        "field":"title"
      }
    }
  }
}
```

ç»“æœï¼š

![image-20210205113515914](https://gitee.com/yxinmiracle/pic/raw/master/20210205113516.png)